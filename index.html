<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>API Docs</title>
  <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    select { margin-bottom: 20px; padding: 5px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>API Documentation</h1>
  <label for="swagger-select">Select API:</label>
  <select id="swagger-select">
    <option value="cars24.yaml">Cars24 API</option>
    <option value="popin.yaml">Popin API</option>
  </select>

  <div id="swagger-ui"></div>

  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
  <script>
    let ui = null;

    function clearSwaggerUI() {
      const container = document.getElementById('swagger-ui');
      if (ui && typeof ui.destroy === 'function') {
        try {
          ui.destroy();
        } catch (e) {
          console.warn('Error destroying previous UI instance:', e);
        }
      }
      // Clear the container content as fallback
      container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
      ui = null;
    }

    async function loadSwagger(fileName) {
      try {
        clearSwaggerUI();
        
        // Fetch the YAML content directly
        const response = await fetch(fileName);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const yamlContent = await response.text();
        
        // Validate YAML content
        let spec;
        try {
          spec = jsyaml.load(yamlContent);
        } catch (yamlError) {
          throw new Error(`Invalid YAML format: ${yamlError.message}`);
        }
        
        if (!spec || typeof spec !== 'object') {
          throw new Error('Invalid OpenAPI specification');
        }
        
        ui = SwaggerUIBundle({
          spec: spec,
          dom_id: '#swagger-ui',
          presets: [SwaggerUIBundle.presets.apis, SwaggerUIBundle.presets.standalone],
          layout: "StandaloneLayout",
          deepLinking: true,
          showExtensions: true,
          showCommonExtensions: true,
          tryItOutEnabled: true,
          onComplete: function() {
            console.log(`Successfully loaded ${fileName}`);
          },
          onFailure: function(error) {
            console.error('SwaggerUI failed to render:', error);
          }
        });
        
      } catch (error) {
        console.error('Error loading Swagger spec:', error);
        document.getElementById('swagger-ui').innerHTML = `
          <div style="padding: 20px; color: red; border: 1px solid red; margin: 20px 0; border-radius: 5px;">
            <h3>‚ùå Error Loading API Documentation</h3>
            <p><strong>Failed to load:</strong> ${fileName}</p>
            <p><strong>Error:</strong> ${error.message}</p>
            <details style="margin-top: 15px;">
              <summary style="cursor: pointer; font-weight: bold;">Troubleshooting Steps</summary>
              <ul style="margin-top: 10px;">
                <li>Verify the file exists in your repository</li>
                <li>Check if GitHub Pages is properly configured</li>
                <li>Ensure the YAML file has valid syntax</li>
                <li>Try refreshing the page</li>
                <li>Check browser console for additional errors</li>
              </ul>
            </details>
            <button onclick="loadSwagger('${fileName}')" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
              üîÑ Retry Loading
            </button>
          </div>
        `;
      }
    }

    // Load first Swagger by default when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Add a small delay to ensure all scripts are loaded
      setTimeout(() => {
        loadSwagger('cars24.yaml');
      }, 100);
    });

    // Change Swagger on dropdown selection
    document.getElementById('swagger-select').addEventListener('change', e => {
      loadSwagger(e.target.value);
    });
  </script>
</body>
</html>
